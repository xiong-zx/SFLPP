\documentclass{article}
\usepackage[final]{report-nips-style}
\bibliographystyle{abbrvnat}
\usepackage{algpseudocode}
\input{myCommand}

\def \Reg {\textsc{Reg}}

\title{INDENG250 Project}
\author{Xinqi Chen \And Zhixiao Xiong \And Shengan Xu}
\date{\today}

\begin{document}
\maketitle

\section{Problem Setup}
We study a facility location problem in which a firm must determine an optimal network of production facilities to serve a set of customers under uncertain tariff conditions. The strategic goal is twofold:
\begin{enumerate}
    \item Cost Efficiency: Minimize the firm’s total operational cost, including production, transportation, and tariff-related expenses.
    \item Supply Resilience: Ensure reliable service to customers even when tariffs increase or fluctuate unpredictably.
\end{enumerate}

This introduces a richer economic interaction: choosing which facilities to open, how to route demand, and at what price to sell goods, while anticipating how customers respond to price changes. 

We will consider a specific instance with a set of customers $I=\{1,...,n\}$ and a set of $m$ potential facility locations $J=\{1,...,m\}$. 

\subsection{Parameters}
\begin{itemize}
  \item $f_j$: The \textit{deterministic} cost to open a facility at location $j\in J$.
  \item $c_{ij}$: The \textit{deterministic} \textit{unit} cost of transportation from facility $j\in J$ to customer $i\in I$.
  \item $h_i(p) = [- a_i p + b_i]_+$: The demand function of customer $i\in I$ with respect to the offered price $p$, where $a_i$ is the parameter of sensitivity to price and $b_i$ is the base demand.
  \item $g_{ij}^{\omega}:$ The \textit{stochastic} \textit{unit} cost induced by the tariff from facility $j\in J$ to customer $i\in I$.
  \item $\bar c_{ij}^{\omega} := c_{ij} + g_{ij}^{\omega}$: The \textit{combined} \textit{stochastic} cost from facility $j\in J$ to customer $i\in I$.
  \item $u_j^{\omega}$: The \textit{stochastic} capacity of facility $j \in J$.
  \item $\alpha$: The service level.
  \item $\xi^{\omega} = \left(\{g_{ij}^{\omega}\}, \{u_j^{\omega}\}\right)$: All \textit{stochastic} information in scenario $\omega$.
\end{itemize}

\subsection{Decision Variables}
\begin{itemize}
  \item $x_j$: A binary variable, where $x_j=1$ if a facility is opened at location $j$, and $0$ otherwise.
  \item $p_i^\omega$: The price on customer $i$ in scenario $\omega$. 
  \item $q_{ij}^\omega$: The amount of customer $i$’s demand that is served by facility $j$ in scenario $\omega$.
\end{itemize}

\subsection{Two-Stage Stochastic Formulation}
We decompose this problem into two stages. At the first stage, we decide whether we will open the facility at certain locations and after that we minimize our cost given the first-stage decision on locations by choosing optimal price and served demand.
\paragraph{First stage}

\begin{align*}
    \min \quad & \sum_{j \in J} f_j x_j + \mathcal{Q}(x) \\
    \text{s.t.} \quad & x_j \in \{0,1\} && \forall j \in J. \\
\end{align*}

where $\mathcal{Q}(x) = \mathcal{R}_\omega \left[ Q(x, \xi^{\omega})\right]$, $\mathcal{R}_\omega$ is a risk measure with stochasticity in $\omega$, and $Q(x,\xi^{\omega})$ is the objective function in the second stage.

\paragraph{Second stage}

\begin{align*}
    Q(x,\xi^{\omega}) &= \min_{p_i^\omega, q_{ij}^\omega} - \sum_{i \in I}\sum_{j\in J} p_i^\omega  q_{ij}^\omega  + \sum_{i \in I} \sum_{j \in J}  q_{ij}^\omega (c_{ij}+g_{ij}^{\omega})  \\
    &= \min_{p_i^\omega, q_{ij}^\omega} - \sum_{i \in I}\sum_{j\in J} (p_i^\omega -\bar c_{ij}^{\omega})  q_{ij}^\omega    \\
    \text{s.t.} \quad 
    & \sum_{j \in J} q_{ij}^\omega \geq (1-\alpha)h_i(p_i^\omega), && \forall i \in I,\\
    & \sum_{j \in J} q_{ij}^\omega  \leq h_i(p_i^\omega), && \forall i \in I,\\
    & \sum_{i \in I} q_{ij}^\omega \le u_j^{\omega} x_j &&  \forall j \in J, \\
    & q_{ij}^\omega  \ge 0 && \forall i \in I,\; \forall j \in J.
\end{align*}

The company can adjust the selling price of its goods to mitigate the impact of tariffs, balancing the tradeoff between tariff-induced cost increases and the potential loss of demand due to higher prices. Moreover, prices are allowed to vary across different locations, enabling the firm to tailor its pricing strategy to regional cost structures, demand characteristics, and tariff exposures.

Since there will be no demand if $p_i > \frac{b_i}{a_i}$, in which case making any goods tailored to customer $i$ will be non-profitable. We can restrict our model in the case $0 \leq p_i \leq \frac{b_i}{a_i}$. 

Sometimes, it can be impractical to decide price in different scenarios.

\subsection{Model with Discretized First-Stage Price Strategies}
\label{sec:model-firststage-discrete}

The difficulty with the continuous-price formulation in the previous subsection is that prices $p_i$ and shipment quantities $q_{ij}^\omega$
enter the second-stage problem in a coupled, nonlinear way through the
demand function $h_i(p_i) = [b_i - a_i p_i]_+$. To restore a structure
that is well suited for Benders decomposition, we approximate the
continuous price range of each customer by a finite set of candidate
price levels and treat the choice among these levels as a discrete
first-stage decision.

For each customer $i \in I$, let $K_i$ denote a finite index set of
candidate price levels, and let
\[
    \bar p_{ik} \in \Big[0,\frac{b_i}{a_i}\Big], 
    \qquad k \in K_i,
\]
be the corresponding (deterministic) prices. For convenience, define the
associated deterministic demand levels
\[
    d_{ik} := h_i(\bar p_{ik})
    = \big[b_i - a_i \bar p_{ik}\big]_+,
    \qquad i \in I,\; k \in K_i.
\]
We assume that the grid $\{\bar p_{ik}\}_{k \in K_i}$ is chosen so that
$d_{ik} \ge 0$ for all $i,k$ of interest.

\paragraph{First-stage decisions.}
In addition to the facility-opening variables $x_j$, we introduce binary
variables $y_{ik}$ indicating the selected price level for each
customer:
\[
    y_{ik} =
    \begin{cases}
        1, & \text{if customer $i$ is offered price } \bar p_{ik},\\
        0, & \text{otherwise.}
    \end{cases}
\]
We enforce the selection of exactly one price level per customer via
\begin{equation}
\label{eq:price-selection-constraints}
    \sum_{k \in K_i} y_{ik} = 1,
    \qquad \forall i \in I.
\end{equation}
The realized price for customer $i$ can then be written as the linear
expression
\begin{equation}
\label{eq:price-from-y}
    p_i(y) 
    := \sum_{k \in K_i} \bar p_{ik} y_{ik},
    \qquad \forall i \in I,
\end{equation}
and the corresponding deterministic demand level becomes
\begin{equation}
\label{eq:demand-from-y}
    H_i(y) 
    := \sum_{k \in K_i} d_{ik} y_{ik},
    \qquad \forall i \in I.
\end{equation}

Let $\Omega$ be the finite set of scenarios with probabilities
$\pi_\omega$, $\omega \in \Omega$. Using the discretized price
representation, the two-stage stochastic program reads
\begin{subequations}\label{eq:model-firststage-discrete}
\begin{align}
    \min_{x,y} \quad 
    & \sum_{j \in J} f_j x_j 
      + \sum_{\omega \in \Omega} \pi_\omega \, Q(x,y;\xi^\omega)
      \label{eq:master-objective-firststage-discrete} \\[2pt]
    \text{s.t.} \quad
    & \sum_{k \in K_i} y_{ik} = 1,
      && \forall i \in I, \label{eq:master-y-simplex}\\
    & x_j \in \{0,1\}, 
      && \forall j \in J, \label{eq:master-x-binary}\\
    & y_{ik} \in \{0,1\},
      && \forall i \in I,\; \forall k \in K_i. 
      \label{eq:master-y-binary}
\end{align}
\end{subequations}

\paragraph{Second-stage (recourse) problem.}
Given first-stage decisions $(x,y)$ and a scenario
$\xi^\omega = \big(\{g_{ij}^\omega\}_{i,j}, \{u_j^\omega\}_{j}\big)$, the
second-stage decisions consist of the shipment quantities
$q_{ij}^\omega \ge 0$. Substituting \eqref{eq:price-from-y} and
\eqref{eq:demand-from-y} into the original recourse problem, we obtain
\begin{subequations}\label{eq:second-stage-firststage-discrete}
\begin{align}
    Q(x,y;\xi^\omega) 
    = \min_{q^\omega} \quad 
    & \sum_{i \in I} \sum_{j \in J} 
      \big(c_{ij} + g_{ij}^\omega - p_i(y)\big) \, q_{ij}^\omega
      \label{eq:sub-objective-firststage-discrete}\\
    \text{s.t.} \quad
    & \sum_{j \in J} q_{ij}^\omega 
      \;\ge\; (1-\alpha)\, H_i(y)
      = (1-\alpha) \sum_{k \in K_i} d_{ik} y_{ik},
      && \forall i \in I, \label{eq:sub-lb-demand-firststage-discrete}\\
    & \sum_{j \in J} q_{ij}^\omega 
      \;\le\; H_i(y)
      = \sum_{k \in K_i} d_{ik} y_{ik},
      && \forall i \in I, \label{eq:sub-ub-demand-firststage-discrete}\\
    & \sum_{i \in I} q_{ij}^\omega 
      \;\le\; u_j^\omega x_j,
      && \forall j \in J, \label{eq:sub-capacity-firststage-discrete}\\
    & q_{ij}^\omega \ge 0,
      && \forall i \in I,\; \forall j \in J. 
      \label{eq:sub-nonneg-firststage-discrete}
\end{align}
\end{subequations}

Note that for fixed $(x,y)$ and $\omega \in \Omega$, the recourse problem
\eqref{eq:second-stage-firststage-discrete} is a linear program in
$q^\omega$. The dependence on the first-stage decisions enters only
through the right-hand sides of the demand and capacity constraints and
through the objective coefficients via $p_i(y)$. Consequently, the dual
feasible region of the recourse problem does not depend on $(x,y)$, and
the recourse function $Q(x,y;\xi^\omega)$ is again the pointwise maximum
of affine functions of $(x,y)$. This restores the usual structure needed
for a Benders decomposition in the joint space of facility-opening
decisions $x$ and discretized price decisions $y$.

\paragraph{Extensive form MILP reformulation.}
For computational benchmarking and solution validation, it is useful to
write out the full extensive form of the discretized model
\eqref{eq:model-firststage-discrete}. By expanding the expectation over
scenarios and incorporating all second-stage constraints directly, we
obtain a single large optimization problem. However, a key challenge arises
in the objective function: the revenue term contains a \emph{bilinear}
product between the price variable $p_i(y)$ (which depends on the
first-stage binary decisions $y_{ik}$) and the second-stage shipment
quantity $q_{ij}^\omega$.

To obtain a pure mixed-integer linear program (MILP), we must linearize
this bilinear term. We achieve this via a McCormick envelope (big-$M$)
reformulation.

\subparagraph{Extensive form with bilinear revenue term.}
Substituting the second-stage recourse problem into the master problem,
the extensive form reads
\begin{align*}
    \min_{x,y,q} \quad
    & \sum_{j \in J} f_j x_j
      + \sum_{\omega \in \Omega} \pi_\omega \sum_{i \in I} \sum_{j \in J}
      \Big( \bar c_{ij}^\omega \, q_{ij}^\omega
      - p_i(y) \, q_{ij}^\omega \Big) \\
    \text{s.t.} \quad
    & \sum_{k \in K_i} y_{ik} = 1,
      && \forall i \in I, \\
    & \sum_{j \in J} q_{ij}^\omega
      \;\ge\; (1-\alpha) \sum_{k \in K_i} d_{ik} y_{ik},
      && \forall i \in I,\; \forall \omega \in \Omega, \\
    & \sum_{j \in J} q_{ij}^\omega
      \;\le\; \sum_{k \in K_i} d_{ik} y_{ik},
      && \forall i \in I,\; \forall \omega \in \Omega, \\
    & \sum_{i \in I} q_{ij}^\omega
      \;\le\; u_j^\omega x_j,
      && \forall j \in J,\; \forall \omega \in \Omega, \\
    & x_j \in \{0,1\},
      && \forall j \in J, \\
    & y_{ik} \in \{0,1\},
      && \forall i \in I,\; \forall k \in K_i, \\
    & q_{ij}^\omega \ge 0,
      && \forall i \in I,\; \forall j \in J,\; \forall \omega \in \Omega.
\end{align*}
The revenue term $-p_i(y) \, q_{ij}^\omega$ is bilinear because
\[
    p_i(y) \, q_{ij}^\omega
    = \Big(\sum_{k \in K_i} \bar p_{ik} y_{ik}\Big) q_{ij}^\omega
    = \sum_{k \in K_i} \bar p_{ik} \, y_{ik} \, q_{ij}^\omega,
\]
where each term $y_{ik} \, q_{ij}^\omega$ is a product of a binary
variable and a continuous variable.

\subparagraph{Linearization via McCormick envelope.}
To linearize each bilinear term $y_{ik} \, q_{ij}^\omega$, we introduce
auxiliary continuous variables
\[
    r_{ijk}^\omega \;\text{representing}\; y_{ik} \, q_{ij}^\omega,
    \qquad i \in I,\; j \in J,\; k \in K_i,\; \omega \in \Omega.
\]
Let $M$ denote an upper bound on $q_{ij}^\omega$ (e.g., $M = \max_{i \in I} b_i$).
The McCormick envelope constraints enforcing $r_{ijk}^\omega = y_{ik} \, q_{ij}^\omega$
are:
\begin{subequations}\label{eq:mccormick-linearization}
\begin{align}
    r_{ijk}^\omega &\le M \, y_{ik},
      && \forall i,j,k,\omega, \label{eq:mccormick-1}\\
    r_{ijk}^\omega &\le q_{ij}^\omega,
      && \forall i,j,k,\omega, \label{eq:mccormick-2}\\
    r_{ijk}^\omega &\ge q_{ij}^\omega - M(1 - y_{ik}),
      && \forall i,j,k,\omega. \label{eq:mccormick-3}
\end{align}
\end{subequations}
When $y_{ik} = 0$, constraints \eqref{eq:mccormick-1} and
\eqref{eq:mccormick-3} force $r_{ijk}^\omega = 0$. When $y_{ik} = 1$,
constraints \eqref{eq:mccormick-2} and \eqref{eq:mccormick-3} together
force $r_{ijk}^\omega = q_{ij}^\omega$, as desired.

Substituting $r_{ijk}^\omega$ for $y_{ik} \, q_{ij}^\omega$, the revenue
term becomes
\[
    - \sum_{\omega \in \Omega} \pi_\omega \sum_{i \in I} \sum_{j \in J}
      p_i(y) \, q_{ij}^\omega
    = - \sum_{\omega \in \Omega} \pi_\omega \sum_{i \in I} \sum_{j \in J}
      \sum_{k \in K_i} \bar p_{ik} \, r_{ijk}^\omega,
\]
which is now \emph{linear} in the variables $(y, q, r)$.

\subparagraph{Final MILP formulation.}
Combining all components, the complete extensive form MILP is
\begin{subequations}\label{eq:extensive-form-milp}
\begin{align}
    \min_{x,y,q,r} \quad
    & \sum_{j \in J} f_j x_j
      + \sum_{\omega \in \Omega} \pi_\omega \sum_{i \in I} \sum_{j \in J}
      \Big( \bar c_{ij}^\omega \, q_{ij}^\omega
      - \sum_{k \in K_i} \bar p_{ik} \, r_{ijk}^\omega \Big)
      \label{eq:milp-obj}\\
    \text{s.t.} \quad
    & \sum_{k \in K_i} y_{ik} = 1,
      && \forall i \in I, \label{eq:milp-y-select}\\
    & \sum_{j \in J} q_{ij}^\omega
      \;\ge\; (1-\alpha) \sum_{k \in K_i} d_{ik} y_{ik},
      && \forall i \in I,\; \forall \omega \in \Omega, \label{eq:milp-demand-lb}\\
    & \sum_{j \in J} q_{ij}^\omega
      \;\le\; \sum_{k \in K_i} d_{ik} y_{ik},
      && \forall i \in I,\; \forall \omega \in \Omega, \label{eq:milp-demand-ub}\\
    & \sum_{i \in I} q_{ij}^\omega
      \;\le\; u_j^\omega x_j,
      && \forall j \in J,\; \forall \omega \in \Omega, \label{eq:milp-capacity}\\
    & r_{ijk}^\omega \le M \, y_{ik},
      && \forall i,j,k,\omega, \label{eq:milp-mccormick-1}\\
    & r_{ijk}^\omega \le q_{ij}^\omega,
      && \forall i,j,k,\omega, \label{eq:milp-mccormick-2}\\
    & r_{ijk}^\omega \ge q_{ij}^\omega - M(1 - y_{ik}),
      && \forall i,j,k,\omega, \label{eq:milp-mccormick-3}\\
    & x_j \in \{0,1\},
      && \forall j \in J, \label{eq:milp-x-binary}\\
    & y_{ik} \in \{0,1\},
      && \forall i \in I,\; \forall k \in K_i, \label{eq:milp-y-binary}\\
    & q_{ij}^\omega \ge 0,
      && \forall i,j,\omega, \label{eq:milp-q-nonneg}\\
    & r_{ijk}^\omega \ge 0,
      && \forall i,j,k,\omega. \label{eq:milp-r-nonneg}
\end{align}
\end{subequations}
This formulation is a pure MILP with $|J| + \sum_{i} |K_i|$ binary variables
and can be solved directly by commercial MILP solvers such as Gurobi or CPLEX.
The quality of the big-$M$ bound directly affects the LP relaxation: tighter
bounds yield stronger relaxations and faster solution times.

\section{Potential Extension}
\paragraph{Algorithm}
\begin{enumerate}
    \item general benders decomposition 
    \item progressive hedging \cindynote{to do}
    \item Mccormick envelope linearization + standard benders \samnote{to do}
\end{enumerate}



\begin{algorithm}[H]
\caption{Progressive Hedging for the Stochastic Facility Location and Pricing Problem}
\label{alg:PH_facility_pricing}
\begin{algorithmic}[1]
\State \textbf{Input:} scenario set $\Omega$, probabilities $p_\omega$, penalty parameter $\rho>0$.
\State \textbf{Initialization:}
\State \quad Set iteration counter $k \gets 0$.
\State \quad Initialize multipliers $u^{\omega,0}_j \gets 0$ for all $j\in J$, $\omega\in\Omega$.
\State \quad Choose an initial feasible solution $x^{\omega,0}_j \in \{0,1\}$ for all $j\in J$, $\omega\in\Omega$.
\State \quad Compute initial consensus (nonanticipative) first-stage decision
\[
    \bar x_j^0 \gets \sum_{\omega\in\Omega} p_\omega x_j^{\omega,0}, \quad \forall j\in J.
\]

\Repeat
    \State $k \gets k+1$.
    \For{each scenario $\omega \in \Omega$}
        \State Solve the following scenario subproblem:
        \begin{align*}
            \min_{x^\omega,\,p^\omega,\,q^\omega} \quad
            & \sum_{j\in J} f_j x_j^\omega
              - \sum_{i\in I}\sum_{j\in J} \big(p_i^\omega - \bar c_{ij}^\omega\big) q_{ij}^\omega \\
            & \quad + \sum_{j\in J} u_{j}^{\omega,k-1} x_j^\omega
              + \frac{\rho}{2} \sum_{j\in J} \big(x_j^\omega - \bar x_j^{k-1}\big)^2 \\
            \text{s.t.} \quad
            & \sum_{j\in J} q_{ij}^\omega \;\ge\; (1-\alpha)\,h_i(p_i^\omega), && \forall i\in I, \\
            & \sum_{j\in J} q_{ij}^\omega \;\le\; h_i(p_i^\omega), && \forall i\in I, \\
            & \sum_{i\in I} q_{ij}^\omega \;\le\; u_j^\omega x_j^\omega, && \forall j\in J, \\
            & q_{ij}^\omega \;\ge\; 0, && \forall i\in I, \forall j\in J, \\
            & 0 \;\le\; p_i^\omega \;\le\; \frac{b_i}{a_i}, && \forall i\in I, \\
            & x_j^\omega \in \{0,1\}, && \forall j\in J.
        \end{align*}
        \State Denote the optimal solution by $(x^{\omega,k}, p^{\omega,k}, q^{\omega,k})$.
    \EndFor
    \State Update the consensus first-stage decision:
    \[
        \bar x_j^{k} \gets \sum_{\omega\in\Omega} p_\omega x_j^{\omega,k},
        \quad \forall j\in J.
    \]
    \State Update the multipliers for the nonanticipativity constraints:
    \[
        u_j^{\omega,k} \gets u_j^{\omega,k-1}
        + \rho \big(x_j^{\omega,k} - \bar x_j^{k}\big),
        \quad \forall j\in J,\ \forall \omega\in\Omega.
    \]
\Until{a stopping criterion is satisfied (e.g.,
$\max_{\omega\in\Omega,\,j\in J} |x_j^{\omega,k} - \bar x_j^k| \le \varepsilon$)}
\State \textbf{Output:} nonanticipative first-stage solution
$\hat x_j \gets \bar x_j^{k}$, $\forall j\in J$, and corresponding second-stage policies $(p^{\omega,k}, q^{\omega,k})$.
\end{algorithmic}
\end{algorithm}



\paragraph{Model and data}
\michaelnote{to do}

\section{Related Work}

\citet{o2015hub, ahmadi2018profit,calvete2024bilevel,lin2023facility}

\bibliography{ref}

\end{document}
